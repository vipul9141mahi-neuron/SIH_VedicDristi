<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herb Registration Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef); 
            font-family: 'Arial', sans-serif;
        }
        .chat-container { 
            max-width: 700px; 
            margin: 0 auto; 
            height: 65vh; 
            overflow-y: auto; 
            padding: 1rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .message { 
            margin-bottom: 1.5rem; 
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bot-message { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            border-radius: 20px 20px 20px 5px; 
            border-left: 4px solid #2196f3;
        }
        .user-message { 
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7); 
            border-radius: 20px 20px 5px 20px; 
            margin-left: 25%; 
            border-right: 4px solid #4caf50;
        }
        .input-section { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: linear-gradient(to top, #fff, #f8f9fa); 
            padding: 1.5rem; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); 
            border-top: 1px solid #dee2e6;
        }
        .voice-active {
            background: #ff4444 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .header-card {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="header-card p-4 text-center shadow">
                    <h2><i class="fas fa-seedling me-2"></i> ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§ö‡•à‡§ü‡§¨‡•â‡§ü</h2>
                    <h4 class="mb-0">Farmer Assistant Chatbot</h4>
                    <p class="mb-0"><i class="fas fa-microphone me-1"></i> Voice Enabled ‚Ä¢ <i class="fas fa-language me-1"></i> Bilingual Support</p>
                </div>

                <div class="chat-container" id="chat-container">
                    <div class="message bot-message p-4">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-robot fa-2x text-primary me-3 mt-1"></i>
                            <div>
                                <strong>‡§∏‡§π‡§æ‡§Ø‡§ï Assistant:</strong><br>
                                üôè ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§°‡§º‡•Ä-‡§¨‡•Ç‡§ü‡•Ä ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï‡§ö‡•á‡§® ‡§™‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ‡•§<br><br>
                                <em>üôè Hello! I will help you securely record your herb information on the blockchain.</em><br><br>
                                ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç / Please tell me your name:
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="input-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card border-0 shadow">
                        <div class="card-body p-3">
                            <div class="input-group">
                                <input type="text" id="user-input" class="form-control form-control-lg border-0" 
                                       placeholder="‡§Ö‡§™‡§®‡§æ ‡§â‡§§‡•ç‡§§‡§∞ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç / Type your answer..." 
                                       onkeypress="handleEnter(event)">
                                <button class="btn btn-primary btn-lg px-4" onclick="sendMessage()" title="Send Message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button class="btn btn-success btn-lg px-4" onclick="toggleVoice()" id="voice-btn" title="Voice Input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Press voice button to speak / ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡•ã‡§≤‡•á‡§Ç
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="height: 180px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 0;
        let farmerData = {};
        let isListening = false;

        const questions = [
            { 
                key: 'farmer_name', 
                question: '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§¨‡§§‡§æ‡§è‡§Ç / Please tell me your full name:',
                validation: (input) => input.trim().length > 1
            },
            { 
                key: 'herb_type', 
                question: '‡§Ü‡§™ ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§ú‡§°‡§º‡•Ä-‡§¨‡•Ç‡§ü‡•Ä ‡§â‡§ó‡§æ‡§§‡•á ‡§π‡•à‡§Ç? <br><em>What herb do you grow?</em>',
                validation: (input) => input.trim().length > 1
            },
            { 
                key: 'location', 
                question: '‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? <br><em>What is your location?</em>',
                validation: (input) => input.trim().length > 2
            },
            { 
                key: 'season', 
                question: '‡§ñ‡•á‡§§‡•Ä ‡§ï‡§æ ‡§Æ‡•å‡§∏‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? <br><em>What is the cultivation season?</em>',
                validation: (input) => input.trim().length > 1
            },
            { 
                key: 'cost_per_kg', 
                question: '‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã ‡§ï‡•Ä‡§Æ‡§§ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? <br><em>What is the cost per kg?</em>',
                validation: (input) => !isNaN(parseFloat(input)) && parseFloat(input) > 0
            }
        ];

        function addMessage(message, isBot = true) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'} p-3`;

            if (isBot) {
                messageDiv.innerHTML = `<div><strong>‡§∏‡§π‡§æ‡§Ø‡§ï:</strong><br>${message}</div>`;
            } else {
                messageDiv.innerHTML = `<div><strong>‡§Ü‡§™:</strong><br>${message}</div>`;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();

            if (message === '') return;

            addMessage(message, false);
            input.value = '';

            processUserInput(message);
        }

        function processUserInput(input) {
            if (currentStep < questions.length) {
                const question = questions[currentStep];

                if (question.validation(input)) {
                    farmerData[question.key] = input;
                    currentStep++;

                    if (currentStep < questions.length) {
                        setTimeout(() => {
                            addMessage(questions[currentStep].question);
                        }, 1000);
                    } else {
                        submitHerbData();
                    }
                } else {
                    setTimeout(() => {
                        addMessage('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§Ç / Please provide a valid answer.');
                    }, 500);
                }
            }
        }

        function submitHerbData() {
            addMessage('‡§°‡•á‡§ü‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç... / Submitting data...');

            fetch('/api/submit_herb_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(farmerData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(() => {
                        addMessage(`
                            <div class="text-center">
                                <h4 class="text-success">üéâ ‡§∏‡§´‡§≤! / Success!</h4>
                                <p>‡§Ü‡§™‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§¨‡•ç‡§≤‡•â‡§ï‡§ö‡•á‡§® ‡§™‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§π‡•à!</p>
                                <p><strong>ID:</strong> ${data.unique_id}</p>
                                <img src="${data.qr_code}" style="max-width: 200px;" class="img-fluid">
                                <p><small>QR ‡§ï‡•ã‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç / Save QR Code</small></p>
                            </div>
                        `);
                    }, 2000);
                } else {
                    addMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error);
                }
            })
            .catch(error => {
                addMessage('‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + error.message);
            });
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function toggleVoice() {
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = 'hi-IN';
                recognition.start();

                recognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    document.getElementById('user-input').value = result;
                };
            } else {
                alert('Voice recognition not supported');
            }
        }
    </script>
</body>
</html>